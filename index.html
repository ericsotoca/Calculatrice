<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculatrice Pro</title>
    <style>
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight */
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrolling on body */
        }

        body {
            background-color: #121212;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px; /* Smaller padding for small screens */
        }

        /* App Container */
        .app-container {
            width: 100%;
            height: 100%;
            max-width: 450px; /* Adjusted max-width for better fit */
            max-height: 800px; /* Limit height */
            background-color: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Calculator */
        .calculator {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: transform 0.5s ease;
            background-color: #202020; /* Slightly different background */
        }

        .calculator.hidden {
            transform: translateY(-110%); /* Ensure it moves completely out */
            position: absolute; /* Allow hidden apps to take space */
            width: 100%;
            height: 100%;
        }

        /* Display */
        .display {
            background-color: #1e1e1e;
            min-height: 100px; /* Min height */
            max-height: 150px; /* Max height */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-end;
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            overflow-y: auto; /* Allow scrolling if needed */
            word-wrap: break-word;
            word-break: break-all;
        }

        .operation {
            font-size: 0.8em; /* Smaller expression font */
            color: #aaa;
            text-align: right;
            min-height: 1.2em;
            width: 100%;
        }

        .result {
            font-size: 2.2em; /* Slightly smaller main result */
            font-weight: bold;
            text-align: right;
            width: 100%;
        }

        /* Buttons */
        .buttons {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 columns */
            gap: 3px; /* Slightly larger gap */
            padding: 10px;
            background-color: #282828; /* Button area background */
            overflow: hidden; /* Prevent buttons overflowing */
        }

        .btn {
            border: none;
            background-color: #3e3e3e; /* Darker buttons */
            color: white;
            font-size: 1.1em; /* Adjusted font size */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.15s ease;
            min-height: 55px; /* Adjusted height */
            border-radius: 8px;
            user-select: none;
            position: relative; /* For Inv indicator */
        }
        .btn sup {
             font-size: 0.6em;
             position: absolute;
             top: 5px;
             left: 5px;
             color: #ffcc00;
             opacity: 0;
             transition: opacity 0.2s;
        }
        .btn.inv-active sup {
             opacity: 1;
        }


        .btn:hover { background-color: #505050; }
        .btn:active { background-color: #606060; }

        .btn.function { background-color: #303030; } /* Functions slightly darker */
        .btn.function:hover { background-color: #454545; }
        .btn.function:active { background-color: #555555; }

        .btn.operator { background-color: #ff9500; }
        .btn.operator:hover { background-color: #ffaa33; }
        .btn.operator:active { background-color: #ffb143; }

        .btn.equals { background-color: #217af4; grid-column: span 1; } /* Normal width */
        .btn.equals:hover { background-color: #398df5; }
        .btn.equals:active { background-color: #4c94f5; }

        .btn.memory { background-color: #5a5a5a; color: #eee;}
        .btn.memory:hover { background-color: #6a6a6a; }
        .btn.memory:active { background-color: #7a7a7a; }

        .btn.toggle { background-color: #1f68c1; } /* DEG/RAD, INV toggles */
        .btn.toggle.active { background-color: #0f4a91; }

        /* Hidden Apps */
        .hidden-apps {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #232323;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.5s ease;
            visibility: hidden;
            z-index: 5;
        }
        .hidden-apps.visible {
            transform: translateY(0);
            visibility: visible;
        }
        .header { padding: 15px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; background-color: #2a2a2a;}
        .header h1 { font-size: 1.3em; }
        .close-btn { background: transparent; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .app-list { flex: 1; overflow-y: auto; padding: 15px; }
        .add-app { padding: 12px; display: flex; justify-content: space-between; background-color: #333; margin-bottom: 10px; border-radius: 8px; align-items: center; cursor: pointer; }
        .add-icon { width: 35px; height: 35px; background-color: #444; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.4em; }
        .app-item { display: flex; align-items: center; padding: 12px; margin-bottom: 10px; background-color: #333; border-radius: 8px; }
        .app-icon { width: 35px; height: 35px; background-color: #444; border-radius: 8px; display: flex; justify-content: center; align-items: center; margin-right: 12px; font-size: 1.4em; flex-shrink: 0; }
        .app-info { flex: 1; cursor: pointer; overflow: hidden; }
        .app-title { font-weight: bold; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .app-desc { font-size: 0.8em; color: #aaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* Note: .app-notes class is not used for display in the list view for security/simplicity */
        .app-actions { display: flex; gap: 8px; }
        .action-btn { background: transparent; border: none; color: #fff; font-size: 1.1em; cursor: pointer; }
        .action-btn.edit { color: #217af4; }
        .action-btn.delete { color: #ff4444; }

        /* App Form */
        .app-form {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #232323;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            visibility: hidden;
            z-index: 6;
        }
        .app-form.visible { transform: translateX(0); visibility: visible; }
        .form-content { padding: 20px; flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; color: #ccc; font-size: 0.9em; }
        .form-input, .form-select, .form-textarea { /* Added .form-textarea */
             width: 100%; padding: 10px; border: 1px solid #444;
             background-color: #333; color: white; border-radius: 4px; font-size: 1em;
        }
        .form-textarea {
            resize: vertical; /* Allow vertical resize only */
            min-height: 80px; /* Give it some initial height */
            font-family: inherit; /* Ensure it uses the same font */
        }

        .form-btn { padding: 12px; background-color: #217af4; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; margin-top: auto; /* Pushes button to bottom if content allows */ }
        .form-btn:hover { background-color: #398df5; }
        .form-btn:active { background-color: #4c94f5; }

        /* Password Screen */
        .password-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; visibility: hidden; opacity: 0; transition: opacity 0.3s ease;
        }
        .password-screen.visible { visibility: visible; opacity: 1; }
        .password-title { font-size: 1.2rem; margin-bottom: 20px; color: #ccc; }
        .password-input {
            width: 80%; max-width: 300px; padding: 15px; border: 1px solid #555;
            background-color: #333; color: white; border-radius: 4px; margin-bottom: 20px;
            text-align: center; font-size: 1.4rem; letter-spacing: 0.3em;
            appearance: none; -webkit-appearance: none;
        }
        .password-input::-webkit-outer-spin-button,
        .password-input::-webkit-inner-spin-button {
             -webkit-appearance: none; margin: 0;
        }
         .password-input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        .password-btn { padding: 12px 30px; background-color: #217af4; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; }
        .password-btn:hover { background-color: #398df5; }
        .password-input.error { border-color: #ff0000; animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
            20%, 40%, 60%, 80% { transform: translateX(6px); }
        }
    </style>
</head>
<body>
    <!-- Password Screen remains the same -->
    <div class="password-screen" id="passwordScreen">
        <h2 class="password-title">Entrez le code secret</h2>
        <input type="number" class="password-input" id="passwordInput" maxlength="6" autocomplete="off" pattern="\d*">
        <button class="password-btn" id="submitPassword">Valider</button>
    </div>

    <div class="app-container">
        <!-- Calculator Area remains the same -->
        <div class="calculator" id="calculator">
            <div class="display">
                <div class="operation" id="operation"></div>
                <div class="result" id="result">0</div>
            </div>
            <div class="buttons">
                <button class="btn function toggle" id="degRadBtn" data-value="DEG">DEG</button>
                <button class="btn function toggle" id="invBtn" data-value="Inv">Inv</button>
                <button class="btn function" data-value="sin"><sup>asin</sup>sin</button>
                <button class="btn function" data-value="cos"><sup>acos</sup>cos</button>
                <button class="btn function" data-value="tan"><sup>atan</sup>tan</button>
                <button class="btn function" data-value="^"><sup>y√x</sup>x<sup>y</sup></button>
                <button class="btn function" data-value="log"><sup>10<sup>x</sup></sup>log</button>
                <button class="btn function" data-value="ln"><sup>e<sup>x</sup></sup>ln</button>
                <button class="btn function" data-value="(">(</button>
                <button class="btn function" data-value=")">)</button>
                <button class="btn function" data-value="sqrt"><sup>x³</sup>√</button>
                 <button class="btn" data-value="C">C</button>
                <button class="btn" data-value="DEL">⌫</button>
                <button class="btn" data-value="%">%</button>
                <button class="btn operator" data-value="/">÷</button>
                <button class="btn function" data-value="x2"><sup>³√x</sup>x²</button>
                <button class="btn" data-value="7">7</button>
                <button class="btn" data-value="8">8</button>
                <button class="btn" data-value="9">9</button>
                <button class="btn operator" data-value="*">×</button>
                <button class="btn function" data-value="!">n!</button>
                <button class="btn" data-value="4">4</button>
                <button class="btn" data-value="5">5</button>
                <button class="btn" data-value="6">6</button>
                <button class="btn operator" data-value="-">−</button>
                <button class="btn function" data-value="pi">π</button>
                <button class="btn" data-value="1">1</button>
                <button class="btn" data-value="2">2</button>
                <button class="btn" data-value="3">3</button>
                <button class="btn operator" data-value="+">+</button>
                <button class="btn function" data-value="e">e</button>
                <button class="btn" data-value="+/-">±</button>
                <button class="btn" data-value="0">0</button>
                <button class="btn" data-value=".">.</button>
                <button class="btn equals" data-value="=">=</button>
            </div>
        </div>

        <!-- Hidden Apps Area remains the same -->
        <div class="hidden-apps" id="hiddenApps">
             <div class="header">
                <h1>Accès cachés</h1>
                <button class="close-btn" id="closeApps">×</button>
            </div>
            <div class="app-list" id="appList">
                
            </div>
        </div>

        <!-- App Form Area - UPDATED -->
        <div class="app-form" id="appForm">
             <div class="header">
                <h1 id="formTitle">Ajouter un accès</h1>
                <button class="close-btn" id="closeForm">×</button>
            </div>
            <div class="form-content">
                
                <div class="form-group">
                    <label class="form-label" for="appTitle">Nom de l'accès</label>
                    <input type="text" class="form-input" id="appTitle" placeholder="Ex. : Banque" maxlength="50" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="appLink">Lien ou description</label>
                    <input type="text" class="form-input" id="appLink" placeholder="Ex. : https://ma-banque.fr ou 'Utiliser app mobile'" maxlength="200" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="appIcon">Icône</label>
                    <select class="form-select" id="appIcon">
                        <option value="💰">💰 (Banque)</option>
                        <option value="🔒">🔒 (Sécurisé)</option>
                        <option value="🌐">🌐 (Web)</option>
                        <option value="📱">📱 (Mobile)</option>
                        <option value="💬">💬 (Messages)</option>
                        <option value="📧">📧 (Email)</option>
                        <option value="🗂️">🗂️ (Documents)</option>
                        <option value="🔑">🔑 (Clé/Mot de passe)</option> {/* Changed Key icon description */}
                        <option value="⭐️">⭐️ (Favori)</option>
                        <option value="💡">💡 (Idée)</option>
                        <option value="⚙️">⚙️ (Paramètres)</option>
                        <option value="👤">👤 (Compte)</option> {/* Added User icon */}
                        <option value="📝">📝 (Note)</option>   {/* Added Note icon */}
                    </select>
                </div>
                {/* NEW Form Group for Notes */}
                <div class="form-group">
                    <label class="form-label" for="appNotes">Notes (identifiant, mdp, etc.)</label>
                    <textarea class="form-textarea" id="appNotes" placeholder="Ajoutez des détails ici (ex: user: monlogin / pass: ***)... Attention: stocké en clair !" rows="4"></textarea>
                </div>

                <input type="hidden" id="editingIndex" value="">
                <button class="form-btn" id="saveApp">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';

            // --- Configuration ---
            const SECRET_CODE = "123456"; // Change this
            const SECRET_CALCULATION = "1+2+3="; // Sequence to trigger password
            const STORAGE_KEY = 'hiddenAppsData_v2'; // Use a new key if structure changed significantly
            const MAX_INPUT_LENGTH = 30;
            const MAX_EXPRESSION_LENGTH = 100;

            // --- State ---
            const state = {
                currentInput: '0',
                expression: '',
                calculationSequence: '',
                isInverse: false,
                isRadians: false,
                memory: 0,
                justCalculated: false,
                openParentheses: 0,
                errorState: false,
                // editingIndex is handled by the hidden input now
            };

            // --- Elements ---
            const elements = {
                calculator: document.getElementById('calculator'),
                hiddenApps: document.getElementById('hiddenApps'),
                appForm: document.getElementById('appForm'),
                passwordScreen: document.getElementById('passwordScreen'),
                passwordInput: document.getElementById('passwordInput'),
                result: document.getElementById('result'),
                operation: document.getElementById('operation'),
                appList: document.getElementById('appList'),
                formTitle: document.getElementById('formTitle'),
                appTitle: document.getElementById('appTitle'),
                appLink: document.getElementById('appLink'),
                appIcon: document.getElementById('appIcon'),
                appNotes: document.getElementById('appNotes'), // <<-- ADDED Notes Textarea
                editingIndexInput: document.getElementById('editingIndex'),
                invBtn: document.getElementById('invBtn'),
                degRadBtn: document.getElementById('degRadBtn'),
                invIndicators: document.querySelectorAll('.btn sup'),
                buttons: document.querySelectorAll('.btn')
            };

            // --- Initialization ---
            function initialize() {
                // Initial visibility
                elements.hiddenApps.classList.remove('visible');
                elements.appForm.classList.remove('visible');
                elements.passwordScreen.classList.remove('visible');
                elements.calculator.classList.remove('hidden');

                // Initialize storage if empty (add 'notes' field)
                 if (!localStorage.getItem(STORAGE_KEY)) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify([
                         { title: "Ma Banque Principale", link: "Accès via application mobile", icon: "💰", notes: "Login: 12345678\nQuestion secrète: Ville naissance" },
                         { title: "Compte Crypto", link: "Utiliser l'app spécifique", icon: "🔒", notes: "2FA activé via Authy" },
                         { title: "Boîte Mail Perso", link: "mail.google.com", icon: "📧", notes: "" }, // Example with empty notes
                         { title: "Cloud Personnel", link: "drive.google.com", icon: "🗂️", notes: "Sauvegarde photos auto" },
                     ]));
                 }
                loadApps();
                updateDisplay();
                bindEvents();
                updateModeButtons();
            }

            // --- Event Binding --- (No changes needed here)
            function bindEvents() {
                // Calculator buttons
                elements.buttons.forEach(button => {
                    button.addEventListener('click', () => handleInput(button.dataset.value));
                });
                // Hidden Apps Controls
                document.getElementById('closeApps').addEventListener('click', closeHiddenApps);
                document.getElementById('closeForm').addEventListener('click', closeAppForm);
                document.getElementById('saveApp').addEventListener('click', saveApp);
                // Password Screen
                document.getElementById('submitPassword').addEventListener('click', checkPassword);
                elements.passwordInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') checkPassword();
                    elements.passwordInput.value = elements.passwordInput.value.replace(/\D/g, '');
                });
                 elements.passwordInput.addEventListener('input', () => {
                     elements.passwordInput.classList.remove('error');
                 });
            }

             // --- Core Input Handler --- (No changes needed here)
             function handleInput(value) {
                if (state.errorState && value !== 'C') return;

                // Track sequence for secret code *before* processing
                state.calculationSequence += value;
                if (state.calculationSequence.endsWith(SECRET_CALCULATION)) {
                    showPasswordScreen();
                    state.calculationSequence = ''; // Reset sequence
                    return; // Stop processing this input
                }
                if (state.calculationSequence.length > SECRET_CALCULATION.length + 5) {
                    state.calculationSequence = state.calculationSequence.slice(-10); // Keep it trimmed
                }

                // Handle different button types
                if (/\d/.test(value)) { handleDigit(value); }
                else if (value === '.') { handleDecimal(); }
                else if (['+', '-', '*', '/', '^'].includes(value)) { handleOperator(value); } // Added ^
                else if (value === '=') { calculate(); }
                else if (value === 'C') { resetCalculator(); }
                else if (value === 'DEL') { handleDelete(); }
                else if (value === '+/-') { toggleSign(); }
                else if (value === '%') { applyPercent(); }
                else if (value === '(' || value === ')') { handleParenthesis(value); }
                else if (value === 'Inv') { toggleInverse(); }
                else if (value === 'DEG' || value === 'RAD') { toggleDegRad(); }
                else if (['MC', 'MR', 'MS', 'M+', 'M-'].includes(value)) { handleMemory(value); }
                else { handleFunction(value); } // Scientific Functions & Constants

                // Update display (most handlers update display, equals/toggle don't need it here)
                 if (!['=', 'Inv', 'DEG', 'RAD'].includes(value) && !state.errorState) {
                    updateDisplay();
                 } else if (state.errorState && value === 'C') {
                     updateDisplay(); // Update display after clearing error
                 }
            }

            // --- Input Handling Helpers --- (No changes needed here)
            function handleDigit(digit) { /* ... unchanged ... */
                if (state.errorState) return;
                if (state.justCalculated || state.currentInput === '0') {
                    state.currentInput = digit;
                } else if (state.currentInput.length < MAX_INPUT_LENGTH) {
                    state.currentInput += digit;
                }
                state.justCalculated = false;
             }
            function handleDecimal() { /* ... unchanged ... */
                 if (state.errorState) return;
                 if (state.justCalculated) {
                     state.currentInput = '0.';
                     state.justCalculated = false;
                 } else if (!state.currentInput.includes('.')) {
                    state.currentInput += '.';
                }
            }
            function handleOperator(op) { /* ... unchanged ... */
                 if (state.errorState) return;
                 // Append current number and operator to expression
                 let currentNum = state.currentInput;
                 // If last op was also an operator (and not '-'), replace it
                 const lastExprChar = state.expression.trim().slice(-1);
                 const secondLastExprChar = state.expression.trim().slice(-2, -1);

                 // Handle expression building more carefully
                 if (state.justCalculated) {
                     state.expression = currentNum; // Start new expression with the result
                     state.justCalculated = false;
                 } else if (currentNum !== '0' || state.expression === '' || state.expression.endsWith('( ')) {
                     // Add the number if it's not the default 0 OR if the expression is empty OR after an opening parenthesis
                     // Handle implicit multiplication before parenthesis if needed
                     if (state.expression.endsWith(') ')) {
                         state.expression += ` * ${currentNum}`;
                     } else {
                         state.expression += ` ${currentNum}`;
                     }
                 } else if (currentNum === '0' && state.expression.endsWith(') ')) {
                     // Handle case like (5+3) followed by operator -> (5+3) * op
                      state.expression += ' *';
                 }


                 // Now add the operator
                  const lastChar = state.expression.trim().slice(-1);
                  if (['+', '*', '/', '^'].includes(lastChar) && op !== '-') {
                      // Replace last operator (unless it's '-' which could be negation)
                       state.expression = state.expression.trim().slice(0, -1) + ` ${op} `;
                  } else if (lastChar === '-' && ['+', '*', '/', '^'].includes(op)) {
                       // Check if previous char was also operator, e.g. 5 * - + -> 5 * +
                       const beforeLast = state.expression.trim().slice(-2,-1);
                       if (['+','*','/','^'].includes(beforeLast)) {
                            state.expression = state.expression.trim().slice(0,-2) + ` ${op} `;
                       } else {
                            state.expression += ` ${op} `;
                       }
                  }
                   else {
                       state.expression += ` ${op} `;
                  }


                 state.currentInput = '0';
                 state.justCalculated = false;
                 if (state.expression.length > MAX_EXPRESSION_LENGTH) {
                     setError("Expression trop longue");
                 }
                 updateDisplay();
             }
            function handleParenthesis(paren) { /* ... unchanged ... */
                if (state.errorState) return;
                if (paren === '(') {
                    const lastInputChar = state.currentInput.slice(-1);
                    const lastExprChar = state.expression.trim().slice(-1);

                    // Add implicit multiplication: 5( -> 5*( ; )( -> )*( ; π( -> π*(
                    if ((!isNaN(parseFloat(lastInputChar)) && state.currentInput !== '0') || state.currentInput === 'Math.PI' || state.currentInput === 'Math.E') {
                        state.expression += ` ${state.currentInput} * `;
                        state.currentInput = '0';
                    } else if (lastExprChar === ')' || !isNaN(parseFloat(lastExprChar)) || lastExprChar === 'E' || lastExprChar === 'I') { // Check for E and I from constants
                        state.expression += ' * ';
                    }

                    state.expression += ' ( ';
                    state.openParentheses++;
                    state.justCalculated = false; // Entering parenthesis resets this
                } else if (paren === ')') {
                    if (state.openParentheses > 0) {
                        // Add current input before closing paren if it's valid
                        const lastExprChar = state.expression.trim().slice(-1);
                        if (state.currentInput !== '0' || lastExprChar === '(') { // Add if not 0, or if directly after ( e.g. "(-5)"
                             // Only add if not directly after an operator, otherwise just close
                             if(!['+','-','*','/','^', '('].includes(lastExprChar)) {
                                state.expression += ` ${state.currentInput} `;
                             } else if (state.currentInput !== '0') { // e.g. 5 * (-3)
                                 state.expression += ` ${state.currentInput} `;
                             }
                        }
                        state.expression += ' ) ';
                        state.openParentheses--;
                        state.currentInput = '0'; // Reset input view, result is now in expression
                        state.justCalculated = false;
                    }
                }
                 updateDisplay();
            }
            function handleDelete() { /* ... unchanged ... */
                 if (state.errorState) return;
                 if (state.justCalculated) { // Allow deleting result to start fresh
                      state.currentInput = '0';
                      state.justCalculated = false;
                 } else if (state.currentInput.length > 1) {
                     state.currentInput = state.currentInput.slice(0, -1);
                 } else if (state.currentInput !== '0') { // If length is 1 but not '0' (e.g. '5' or '-')
                     state.currentInput = '0';
                 }
                 // Don't allow backspace to remove '0'
                 updateDisplay();
             }
            function toggleSign() { /* ... unchanged ... */
                 if (state.errorState || state.currentInput === '0') return;
                 // If result was just calculated, apply sign to it
                 if (state.justCalculated) {
                     state.justCalculated = false; // Operate on the result now
                 }
                 if (state.currentInput.startsWith('-')) {
                     state.currentInput = state.currentInput.substring(1);
                 } else {
                     state.currentInput = '-' + state.currentInput;
                 }
                  updateDisplay();
             }
            function applyPercent() { /* ... unchanged ... */
                 if (state.errorState) return;
                 try {
                     const currentValue = parseFloat(state.currentInput);
                     // Basic percentage for now
                     state.currentInput = formatResult(currentValue / 100);
                     state.justCalculated = true; // Treat percent like a calculation
                     updateDisplay();
                 } catch (e) {
                     setError("Erreur");
                 }
            }
            function toggleInverse() { /* ... unchanged ... */
                 if (state.errorState) return;
                 state.isInverse = !state.isInverse;
                 elements.invBtn.classList.toggle('active', state.isInverse);
                 elements.invIndicators.forEach(sup => {
                     sup.parentElement.classList.toggle('inv-active', state.isInverse);
                 });
             }
            function toggleDegRad() { /* ... unchanged ... */
                if (state.errorState) return;
                 state.isRadians = !state.isRadians;
                 updateModeButtons();
            }
            function updateModeButtons() { /* ... unchanged ... */
                 if (state.isRadians) {
                     elements.degRadBtn.textContent = 'RAD';
                     elements.degRadBtn.dataset.value = 'RAD';
                 } else {
                     elements.degRadBtn.textContent = 'DEG';
                     elements.degRadBtn.dataset.value = 'DEG';
                 }
                 elements.degRadBtn.classList.toggle('active', state.isRadians);
             }
            function handleMemory(action) { /* ... unchanged ... */
                 if (state.errorState) return;
                 let currentValue = 0;
                 try {
                     // Try to evaluate current input if it looks complex, otherwise parse float
                      currentValue = parseFloat(state.currentInput); // Keep it simple for now
                 } catch(e) { /* ignore parse error */ }

                 if (isNaN(currentValue) && action !== 'MR' && action !== 'MC') return;

                 switch (action) {
                     case 'MS': state.memory = currentValue; state.justCalculated = true; break;
                     case 'MR':
                         state.currentInput = state.memory.toString();
                         state.justCalculated = false; // Allow operating on recalled value
                         updateDisplay(); // Update display immediately after MR
                         return; // Don't run updateDisplay again below
                     case 'MC': state.memory = 0; break;
                     case 'M+': state.memory += currentValue; state.justCalculated = true; break;
                     case 'M-': state.memory -= currentValue; state.justCalculated = true; break;
                 }
                 // Optionally display 'M' indicator (needs HTML element)
                 // console.log("Memory:", state.memory); // Log memory state
                 updateDisplay();
            }


            // --- Calculation --- (No changes needed here)
            function calculate() { /* ... unchanged ... */
                 if (state.errorState) return;
                 // Append the final number if needed
                 if (!state.justCalculated) {
                     const lastExprChar = state.expression.trim().slice(-1);
                     // Add current input if it's not default '0' OR if expression is empty OR after an operator/opening paren
                     if (state.currentInput !== '0' || state.expression === '' || ['+','-','*','/','^','('].includes(lastExprChar) ) {
                          state.expression += ` ${state.currentInput}`;
                     }
                 }


                // Auto-close parentheses
                if (state.openParentheses > 0) {
                    state.expression += ' )'.repeat(state.openParentheses);
                    state.openParentheses = 0;
                }

                let expressionToEvaluate = state.expression.trim();
                 if (!expressionToEvaluate) {
                     // If only a number was entered, maybe keep it? Or do nothing? Let's do nothing.
                      // If justCalculated is true, the result is already in currentInput.
                      if (!state.justCalculated) {
                          state.expression = state.currentInput; // Display the number as the "operation"
                          updateDisplay();
                      }
                      return;
                 }

                 console.log("Raw expression:", expressionToEvaluate);
                 if (expressionToEvaluate) {
                    try {
                        expressionToEvaluate = prepareExpression(expressionToEvaluate);
                         console.log("Prepared expression:", expressionToEvaluate);

                        // Use Function constructor
                        const calculateFn = new Function('return ' + expressionToEvaluate);
                        let result = calculateFn();

                        if (!Number.isFinite(result)) throw new Error("Résultat invalide");

                        elements.operation.textContent = state.expression.trim() + ' =';
                        state.currentInput = formatResult(result);
                        state.expression = ''; // Reset expression for next calculation
                        state.justCalculated = true;
                        state.errorState = false;

                    } catch (e) {
                         console.error("Calculation error:", e, "Expression:", expressionToEvaluate);
                         setError("Erreur");
                    }
                 } else {
                     elements.operation.textContent = '';
                 }
                 updateDisplay();
             }
             function prepareExpression(expr) { /* ... unchanged ... */
                 // Replace user symbols
                 expr = expr.replace(/×/g, '*').replace(/÷/g, '/').replace(/−/g, '-');
                 expr = expr.replace(/\^/g, '**'); // Use exponentiation operator

                 // Replace constants (carefully)
                 expr = expr.replace(/π/g, 'Math.PI');
                 expr = expr.replace(/e(?!\w)/g, 'Math.E'); // Avoid 'exp'

                 // Add Math. prefix to functions (basic replacement - needs improvement for complex cases)
                 // This part is still simplified and might fail on nested or complex scenarios.
                 // A proper parser/evaluator library would be more robust.
                  const functions = ['sin', 'cos', 'tan', 'asin', 'acos', 'atan', 'log10', 'log', 'exp', 'sqrt', 'cbrt', 'pow'];
                  functions.forEach(f => {
                      // Simple regex, might need refinement
                      const regex = new RegExp(`(?<!Math\\.)${f}\\(`, 'g');
                      expr = expr.replace(regex, `Math.${f}(`);
                  });


                  // Handle degrees for trig functions (wrap arguments)
                  if (!state.isRadians) {
                      const trigFuncs = ['sin', 'cos', 'tan'];
                      trigFuncs.forEach(f => {
                          const regex = new RegExp(`Math\.${f}\\(([^)]+)\\)`, 'g');
                           expr = expr.replace(regex, (match, arg) => `Math.${f}(${arg} * (Math.PI / 180))`);
                      });
                      const invTrigFuncs = ['asin', 'acos', 'atan'];
                      invTrigFuncs.forEach(f => {
                           const regex = new RegExp(`Math\.${f}\\(([^)]+)\\)`, 'g');
                           expr = expr.replace(regex, (match, arg) => `(Math.${f}(${arg}) * (180 / Math.PI))`);
                      });
                  }


                 return expr;
             }
             function handleFunction(func) { /* ... unchanged ... */
                  if (state.errorState) return;
                  let valueStr = state.currentInput; // Work with string for potential constants
                  let value = parseFloat(valueStr);
                  let requiresInverse = ['sin', 'cos', 'tan', 'log', 'ln', 'sqrt', 'x2', '^']; // ^ handled by operator now
                  const isFuncInverse = state.isInverse && requiresInverse.includes(func);

                  // If input is not a number, but a constant, apply func to the constant
                  if (isNaN(value)) {
                      if (valueStr === 'Math.PI') value = Math.PI;
                      else if (valueStr === 'Math.E') value = Math.E;
                      else return; // Cannot operate
                  }

                  // Reset expression if starting new calc with a function after '='
                  if (state.justCalculated) {
                      state.expression = '';
                      state.justCalculated = false;
                  }


                 try {
                     let result;
                     let funcName = func; // Keep original name for display/logging
                     let useParens = false; // Should this function add parenthesis?

                     // Prepare the function call string for the expression
                     let mathFunc;
                     let isConstant = false;

                     switch (func) {
                         // Trig
                         case 'sin': mathFunc = isFuncInverse ? 'asin' : 'sin'; useParens=true; break;
                         case 'cos': mathFunc = isFuncInverse ? 'acos' : 'cos'; useParens=true; break;
                         case 'tan': mathFunc = isFuncInverse ? 'atan' : 'tan'; useParens=true; break;
                         // Log / Exp
                         case 'log': mathFunc = isFuncInverse ? 'pow(10, ' : 'log10'; useParens=!isFuncInverse; break; // Special case for 10^x
                         case 'ln': mathFunc = isFuncInverse ? 'exp' : 'log'; useParens=true; break;
                         // Powers / Roots
                         case 'sqrt': mathFunc = isFuncInverse ? 'pow(x, 3)' : 'sqrt'; if(isFuncInverse) mathFunc='cbrt'; else mathFunc='sqrt'; useParens=true; break; // Inv = cbrt
                         case 'x2': mathFunc = isFuncInverse ? 'cbrt' : 'pow(x, 2)'; if(isFuncInverse) mathFunc='cbrt'; else mathFunc = 'pow'; useParens=true; break; // Inv = cbrt

                         // Constants (replace input directly)
                         case 'pi': state.currentInput = 'Math.PI'; isConstant=true; break;
                         case 'e': state.currentInput = 'Math.E'; isConstant=true; break;

                          // Factorial (Immediate calculation)
                          case '!':
                              if (!Number.isInteger(value) || value < 0) throw new Error("Factorial Error");
                              result = factorial(value);
                              state.currentInput = formatResult(result);
                              state.justCalculated = true;
                              updateDisplay();
                              return; // Factorial calculated immediately

                          default: return; // Unknown function
                      }

                     if (isConstant) {
                         state.justCalculated = false; // Setting constant doesn't count as calculation
                         updateDisplay();
                         return;
                     }

                     // Build function part of the expression
                     if (mathFunc) {
                          let funcPrefix = `Math.${mathFunc}`;
                           if(func === 'log' && isFuncInverse) funcPrefix = 'Math.pow(10, '; // 10^x needs custom handling
                           if(func === 'x2' && !isFuncInverse) funcPrefix = 'Math.pow('; // x^2 needs pow(val, 2)


                           // Add implicit multiplication if needed
                           const lastExprChar = state.expression.trim().slice(-1);
                           if (state.currentInput !== '0' || state.expression === '') {
                               // If current input is a number, use it as the argument
                               state.expression += ` ${funcPrefix}${state.currentInput}`;
                               if (func === 'x2' && !isFuncInverse) state.expression += ', 2'; // Add the exponent for pow
                               if (useParens || (func === 'log' && isFuncInverse) || (func === 'x2' && !isFuncInverse)) state.expression += ') ';
                               state.currentInput = '0'; // Clear input field
                           } else if (lastExprChar === ')' || !isNaN(parseFloat(lastExprChar)) || lastExprChar === 'E' || lastExprChar === 'I' ) {
                               // Apply function to the result of previous expression part
                               state.expression = ` ${funcPrefix}${state.expression.trim()}`;
                                if (func === 'x2' && !isFuncInverse) state.expression += ', 2';
                                if (useParens || (func === 'log' && isFuncInverse) || (func === 'x2' && !isFuncInverse)) state.expression += ') ';
                           } else {
                                // Apply function without implicit multiplication (e.g. after operator)
                                state.expression += ` ${funcPrefix}`;
                                if(useParens) state.expression += '( '; // Open paren for next number
                           }

                           state.justCalculated = false;
                           if (useParens && !state.expression.endsWith(') ')) {
                               // If we added func( we need to increment open parens
                               state.openParentheses++;
                           }
                      }


                 } catch (e) {
                     setError("Erreur");
                     console.error("Function error:", e);
                 }
                  if (state.isInverse) toggleInverse(); // Auto-toggle off inverse after use? Optional.
                 updateDisplay();
             }
             function factorial(n) { /* ... unchanged ... */
                 if (n < 0 || !Number.isInteger(n)) return NaN;
                 if (n === 0 || n === 1) return 1;
                  if (n > 170) return Infinity; // Prevent issues with large factorials
                 let result = 1;
                 for (let i = n; i > 1; i--) { result *= i; }
                 return result;
             }
             function formatResult(value) { /* ... unchanged ... */
                  if (Math.abs(value) > 1e12 || (Math.abs(value) < 1e-9 && value !== 0)) {
                     return value.toExponential(8); // More precision for exponential
                 } else {
                      // Use Number.toPrecision to handle both large and small decimals gracefully
                      // Convert back to number then string to remove trailing zeros potentially introduced
                       return parseFloat(Number(value).toPrecision(12)).toString();
                 }
             }

            // --- Display Update --- (No changes needed here)
             function updateDisplay() { /* ... unchanged ... */
                 // Limit display length visually if needed, but keep full value in state.currentInput
                 let displayValue = state.currentInput;
                 // Handle potential constants displayed
                 if (displayValue === 'Math.PI') displayValue = 'π';
                 if (displayValue === 'Math.E') displayValue = 'e';

                 elements.result.textContent = displayValue;
                 if (!state.errorState) {
                     elements.operation.textContent = state.expression;
                 } else {
                      elements.operation.textContent = ''; // Clear expression on error
                 }
                 // Adjust font size (optional)
                 const len = displayValue.length;
                 if (len > 22) elements.result.style.fontSize = '1.2em';
                 else if (len > 15) elements.result.style.fontSize = '1.5em';
                 else if (len > 10) elements.result.style.fontSize = '1.8em';
                 else elements.result.style.fontSize = '2.2em';
             }

            // --- Error Handling --- (No changes needed here)
            function setError(message) { /* ... unchanged ... */
                state.currentInput = message;
                state.expression = '';
                state.errorState = true;
                state.openParentheses = 0; // Reset parens count on error
                updateDisplay();
            }

            // --- Reset --- (No changes needed here)
            function resetCalculator() { /* ... unchanged ... */
                state.currentInput = '0';
                state.expression = '';
                state.calculationSequence = '';
                // Keep DEG/RAD and INV state? Let's keep them.
                state.justCalculated = false;
                state.openParentheses = 0;
                 state.errorState = false;
                updateDisplay();
            }

            // --- Hidden Apps Logic ---

            function showPasswordScreen() { /* ... unchanged ... */
                resetCalculator();
                elements.passwordScreen.classList.add('visible');
                elements.passwordInput.value = '';
                elements.passwordInput.classList.remove('error');
                elements.passwordInput.focus();
             }
            function checkPassword() { /* ... unchanged ... */
                 if (elements.passwordInput.value === SECRET_CODE) {
                    elements.passwordScreen.classList.remove('visible');
                    elements.calculator.classList.add('hidden');
                    elements.hiddenApps.classList.add('visible');
                    elements.passwordInput.value = '';
                    loadApps(); // Refresh app list
                } else {
                    elements.passwordInput.classList.add('error');
                    elements.passwordInput.value = '';
                    setTimeout(() => {
                         if (elements.passwordInput) {
                             elements.passwordInput.classList.remove('error');
                         }
                    }, 500);
                }
            }
            function closeHiddenApps() { /* ... unchanged ... */
                 elements.hiddenApps.classList.remove('visible');
                 elements.calculator.classList.remove('hidden');
                 resetCalculator();
             }
            function closeAppForm() { /* ... unchanged ... */
                 elements.appForm.classList.remove('visible');
             }

            // --- UPDATED Hidden Apps Data Handling ---

             function loadApps() {
                 const apps = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                 const fragment = document.createDocumentFragment();

                 // Add "Add App" button first
                 const addAppDiv = document.createElement('div');
                 addAppDiv.className = 'add-app';
                 addAppDiv.id = 'addAppBtn';
                 addAppDiv.innerHTML = `
                     <div>
                         <div class="app-title">Ajouter un accès</div>
                         <div class="app-desc">Créer un nouvel accès sécurisé</div>
                     </div>
                     <div class="add-icon">+</div>
                 `;
                 addAppDiv.addEventListener('click', openAddForm);
                 fragment.appendChild(addAppDiv);

                 // Add existing apps
                 apps.forEach((app, index) => {
                     const appItem = document.createElement('div');
                     appItem.className = 'app-item';
                     // Notes are NOT displayed in the list view itself
                     appItem.innerHTML = `
                         <div class="app-icon">${sanitize(app.icon || '❓')}</div>
                         <div class="app-info">
                             <div class="app-title">${sanitize(app.title)}</div>
                             <div class="app-desc">${sanitize(app.link)}</div>
                         </div>
                         <div class="app-actions">
                             <button class="action-btn edit" data-index="${index}" title="Modifier">✏️</button>
                             <button class="action-btn delete" data-index="${index}" title="Supprimer">🗑️</button>
                         </div>
                     `;
                     appItem.querySelector('.app-info').addEventListener('click', () => openLink(app.link, app.title));
                     appItem.querySelector('.edit').addEventListener('click', (e) => { e.stopPropagation(); editApp(index); });
                     appItem.querySelector('.delete').addEventListener('click', (e) => { e.stopPropagation(); deleteApp(index); });
                     fragment.appendChild(appItem);
                 });

                 elements.appList.innerHTML = '';
                 elements.appList.appendChild(fragment);
             }

             function sanitize(str) { /* ... unchanged ... */
                 const temp = document.createElement('div');
                 temp.textContent = str;
                 return temp.innerHTML;
             }

             function openLink(link, title) { /* ... unchanged ... */
                  if (/^https?:\/\//i.test(link) || /^mailto:/i.test(link) || /^tel:/i.test(link)) {
                     window.open(link, '_blank', 'noopener,noreferrer');
                 } else if (/^\w+:\/\//i.test(link)) {
                      window.open(link, '_blank', 'noopener,noreferrer');
                 }
                  else {
                     alert(`Accès: ${title}\nInfo: ${link}`);
                 }
             }

             function openAddForm() { // <<-- UPDATED
                 elements.editingIndexInput.value = ''; // Clear index
                 elements.formTitle.textContent = "Ajouter un accès";
                 elements.appTitle.value = '';
                 elements.appLink.value = '';
                 elements.appIcon.value = '💰';
                 elements.appNotes.value = ''; // Clear notes field
                 elements.appForm.classList.add('visible');
             }

             function saveApp() { // <<-- UPDATED
                 const title = elements.appTitle.value.trim();
                 const link = elements.appLink.value.trim();
                 const icon = elements.appIcon.value;
                 const notes = elements.appNotes.value.trim(); // Get notes value
                 const indexToEdit = elements.editingIndexInput.value;

                 if (!title || !link) { // Notes are optional
                     alert("Le nom et le lien/description sont obligatoires.");
                     return;
                 }

                 const apps = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                 const newApp = { title, link, icon, notes }; // Include notes in the object

                 if (indexToEdit !== '') {
                     const idx = parseInt(indexToEdit, 10);
                     if (idx >= 0 && idx < apps.length) {
                         apps[idx] = newApp;
                     }
                 } else {
                     apps.push(newApp);
                 }

                 localStorage.setItem(STORAGE_KEY, JSON.stringify(apps));
                 closeAppForm();
                 loadApps(); // Refresh list
             }

             function editApp(index) { // <<-- UPDATED
                 const apps = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                 if (index >= 0 && index < apps.length) {
                     const app = apps[index];
                     elements.editingIndexInput.value = index.toString();
                     elements.formTitle.textContent = "Modifier l'accès";
                     elements.appTitle.value = app.title;
                     elements.appLink.value = app.link;
                     elements.appIcon.value = app.icon || '💰';
                     elements.appNotes.value = app.notes || ''; // Populate notes field
                     elements.appForm.classList.add('visible');
                 }
             }

             function deleteApp(index) { /* ... unchanged ... */
                 if (!confirm("Voulez-vous vraiment supprimer cet accès ? Cette action est irréversible.")) {
                      return;
                  }
                 const apps = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                 if (index >= 0 && index < apps.length) {
                     apps.splice(index, 1);
                     localStorage.setItem(STORAGE_KEY, JSON.stringify(apps));
                     loadApps();
                 }
             }

            // --- Start the App ---
            document.addEventListener('DOMContentLoaded', initialize);

        })();
    </script>
</body>
</html>
