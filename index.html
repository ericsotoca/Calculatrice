<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculatrice Pro</title>
    <style>
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight */
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrolling on body */
        }

        body {
            background-color: #121212;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px; /* Smaller padding for small screens */
        }

        /* App Container */
        .app-container {
            width: 100%;
            height: 100%;
            max-width: 450px; /* Adjusted max-width for better fit */
            max-height: 800px; /* Limit height */
            background-color: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Calculator */
        .calculator {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: transform 0.5s ease;
            background-color: #202020; /* Slightly different background */
        }

        .calculator.hidden {
            transform: translateY(-110%); /* Ensure it moves completely out */
            position: absolute; /* Allow hidden apps to take space */
            width: 100%;
            height: 100%;
        }

        /* Display */
        .display {
            background-color: #1e1e1e;
            min-height: 100px; /* Min height */
            max-height: 150px; /* Max height */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-end;
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            overflow-y: auto; /* Allow scrolling if needed */
            word-wrap: break-word;
            word-break: break-all;
        }

        .operation {
            font-size: 0.8em; /* Smaller expression font */
            color: #aaa;
            text-align: right;
            min-height: 1.2em;
            width: 100%;
        }

        .result {
            font-size: 2.2em; /* Slightly smaller main result */
            font-weight: bold;
            text-align: right;
            width: 100%;
        }

        /* Buttons */
        .buttons {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 columns */
            gap: 3px; /* Slightly larger gap */
            padding: 10px;
            background-color: #282828; /* Button area background */
            overflow: hidden; /* Prevent buttons overflowing */
        }

        .btn {
            border: none;
            background-color: #3e3e3e; /* Darker buttons */
            color: white;
            font-size: 1.1em; /* Adjusted font size */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.15s ease;
            min-height: 55px; /* Adjusted height */
            border-radius: 8px;
            user-select: none;
            position: relative; /* For Inv indicator */
        }
        .btn sup {
             font-size: 0.6em;
             position: absolute;
             top: 5px;
             left: 5px;
             color: #ffcc00;
             opacity: 0;
             transition: opacity 0.2s;
        }
        .btn.inv-active sup {
             opacity: 1;
        }


        .btn:hover { background-color: #505050; }
        .btn:active { background-color: #606060; }

        .btn.function { background-color: #303030; } /* Functions slightly darker */
        .btn.function:hover { background-color: #454545; }
        .btn.function:active { background-color: #555555; }

        .btn.operator { background-color: #ff9500; }
        .btn.operator:hover { background-color: #ffaa33; }
        .btn.operator:active { background-color: #ffb143; }

        .btn.equals { background-color: #217af4; grid-column: span 1; } /* Normal width */
        .btn.equals:hover { background-color: #398df5; }
        .btn.equals:active { background-color: #4c94f5; }

        .btn.memory { background-color: #5a5a5a; color: #eee;}
        .btn.memory:hover { background-color: #6a6a6a; }
        .btn.memory:active { background-color: #7a7a7a; }

        .btn.toggle { background-color: #1f68c1; } /* DEG/RAD, INV toggles */
        .btn.toggle.active { background-color: #0f4a91; }

        /* Hidden Apps (styles mostly unchanged) */
        .hidden-apps {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #232323;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.5s ease;
            visibility: hidden;
            z-index: 5; /* Ensure it's above the calculator when visible */
        }
        .hidden-apps.visible {
            transform: translateY(0);
            visibility: visible;
        }
        .header { padding: 15px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; background-color: #2a2a2a;}
        .header h1 { font-size: 1.3em; }
        .close-btn { background: transparent; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .app-list { flex: 1; overflow-y: auto; padding: 15px; }
        .add-app { padding: 12px; display: flex; justify-content: space-between; background-color: #333; margin-bottom: 10px; border-radius: 8px; align-items: center; cursor: pointer; }
        .add-icon { width: 35px; height: 35px; background-color: #444; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.4em; }
        .app-item { display: flex; align-items: center; padding: 12px; margin-bottom: 10px; background-color: #333; border-radius: 8px; }
        .app-icon { width: 35px; height: 35px; background-color: #444; border-radius: 8px; display: flex; justify-content: center; align-items: center; margin-right: 12px; font-size: 1.4em; flex-shrink: 0; }
        .app-info { flex: 1; cursor: pointer; overflow: hidden; }
        .app-title { font-weight: bold; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .app-desc { font-size: 0.8em; color: #aaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .app-actions { display: flex; gap: 8px; }
        .action-btn { background: transparent; border: none; color: #fff; font-size: 1.1em; cursor: pointer; }
        .action-btn.edit { color: #217af4; }
        .action-btn.delete { color: #ff4444; }

        /* App Form (styles mostly unchanged) */
        .app-form {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #232323;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            visibility: hidden;
            z-index: 6; /* Above hidden apps */
        }
        .app-form.visible { transform: translateX(0); visibility: visible; }
        .form-content { padding: 20px; flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; color: #ccc; font-size: 0.9em; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #444; background-color: #333; color: white; border-radius: 4px; font-size: 1em; }
        .form-btn { padding: 12px; background-color: #217af4; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; margin-top: auto; }
        .form-btn:hover { background-color: #398df5; }
        .form-btn:active { background-color: #4c94f5; }

        /* Password Screen (styles mostly unchanged) */
        .password-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; visibility: hidden; opacity: 0; transition: opacity 0.3s ease;
        }
        .password-screen.visible { visibility: visible; opacity: 1; }
        .password-title { font-size: 1.2rem; margin-bottom: 20px; color: #ccc; }
        .password-input {
            width: 80%; max-width: 300px; padding: 15px; border: 1px solid #555;
            background-color: #333; color: white; border-radius: 4px; margin-bottom: 20px;
            text-align: center; font-size: 1.4rem; letter-spacing: 0.3em;
            appearance: none; -webkit-appearance: none; /* Try to hide spinners */
        }
        .password-input::-webkit-outer-spin-button,
        .password-input::-webkit-inner-spin-button {
             -webkit-appearance: none;
              margin: 0; /* Might help */
        }
         .password-input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        .password-btn { padding: 12px 30px; background-color: #217af4; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; }
        .password-btn:hover { background-color: #398df5; }
        .password-input.error { border-color: #ff0000; animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
            20%, 40%, 60%, 80% { transform: translateX(6px); }
        }
    </style>
</head>
<body>
    <!-- Password Screen remains the same -->
    <div class="password-screen" id="passwordScreen">
        <h2 class="password-title">Entrez le code secret</h2>
        <input type="number" class="password-input" id="passwordInput" maxlength="6" autocomplete="off" pattern="\d*">
        <button class="password-btn" id="submitPassword">Valider</button>
    </div>

    <div class="app-container">
        <div class="calculator" id="calculator">
            <div class="display">
                <div class="operation" id="operation"></div>
                <div class="result" id="result">0</div>
            </div>
            <div class="buttons">
                <!-- Row 1 -->
                <button class="btn function toggle" id="degRadBtn" data-value="DEG">DEG</button>
                <button class="btn function toggle" id="invBtn" data-value="Inv">Inv</button>
                <button class="btn function" data-value="sin"><sup>asin</sup>sin</button>
                <button class="btn function" data-value="cos"><sup>acos</sup>cos</button>
                <button class="btn function" data-value="tan"><sup>atan</sup>tan</button>
                <!-- Row 2 -->
                <button class="btn function" data-value="^"><sup>y√x</sup>x<sup>y</sup></button>
                <button class="btn function" data-value="log"><sup>10<sup>x</sup></sup>log</button>
                <button class="btn function" data-value="ln"><sup>e<sup>x</sup></sup>ln</button>
                <button class="btn function" data-value="(">(</button>
                <button class="btn function" data-value=")">)</button>
                <!-- Row 3 -->
                <button class="btn function" data-value="sqrt"><sup>x³</sup>√</button>
                 <button class="btn" data-value="C">C</button>
                <button class="btn" data-value="DEL">⌫</button>
                <button class="btn" data-value="%">%</button>
                <button class="btn operator" data-value="/">÷</button>
                <!-- Row 4 -->
                <button class="btn function" data-value="x2"><sup>³√x</sup>x²</button>
                <button class="btn" data-value="7">7</button>
                <button class="btn" data-value="8">8</button>
                <button class="btn" data-value="9">9</button>
                <button class="btn operator" data-value="*">×</button>
                <!-- Row 5 -->
                <button class="btn function" data-value="!">n!</button>
                <button class="btn" data-value="4">4</button>
                <button class="btn" data-value="5">5</button>
                <button class="btn" data-value="6">6</button>
                <button class="btn operator" data-value="-">−</button>
                <!-- Row 6 -->
                <button class="btn function" data-value="pi">π</button>
                <button class="btn" data-value="1">1</button>
                <button class="btn" data-value="2">2</button>
                <button class="btn" data-value="3">3</button>
                <button class="btn operator" data-value="+">+</button>
                 <!-- Row 7 -->
                <button class="btn function" data-value="e">e</button>
                <button class="btn" data-value="+/-">±</button>
                <button class="btn" data-value="0">0</button>
                <button class="btn" data-value=".">.</button>
                <button class="btn equals" data-value="=">=</button>
                <!-- Row 8: Memory - Optional, can be removed if too cluttered -->
                <!-- <button class="btn memory" data-value="MC">MC</button>
                <button class="btn memory" data-value="MR">MR</button>
                <button class="btn memory" data-value="MS">MS</button>
                <button class="btn memory" data-value="M+">M+</button>
                <button class="btn memory" data-value="M-">M-</button> -->
            </div>
        </div>

        <!-- Hidden Apps Area remains the same -->
        <div class="hidden-apps" id="hiddenApps">
             <div class="header">
                <h1>Accès cachés</h1>
                <button class="close-btn" id="closeApps">×</button>
            </div>
            <div class="app-list" id="appList">
                 <!-- Add button is dynamically prepended now -->
            </div>
        </div>

        <!-- App Form Area remains the same -->
        <div class="app-form" id="appForm">
             <div class="header">
                <h1 id="formTitle">Ajouter un accès</h1>
                <button class="close-btn" id="closeForm">×</button>
            </div>
            <div class="form-content">
                <div class="form-group">
                    <label class="form-label" for="appTitle">Nom de l'accès</label>
                    <input type="text" class="form-input" id="appTitle" placeholder="Ex. : Banque" maxlength="50" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="appLink">Lien ou description</label>
                    <input type="text" class="form-input" id="appLink" placeholder="Ex. : https://ma-banque.fr" maxlength="200" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="appIcon">Icône</label>
                    <select class="form-select" id="appIcon">
                        <option value="💰">💰 (Banque)</option>
                        <option value="🔒">🔒 (Sécurisé)</option>
                        <option value="🌐">🌐 (Web)</option>
                        <option value="📱">📱 (Mobile)</option>
                        <option value="💬">💬 (Messages)</option>
                        <option value="📧">📧 (Email)</option>
                        <option value="🗂️">🗂️ (Documents)</option>
                        <option value="🔑">🔑 (Clé)</option>
                        <option value="⭐️">⭐️ (Favori)</option>
                        <option value="💡">💡 (Idée)</option>
                        <option value="⚙️">⚙️ (Paramètres)</option>
                    </select>
                </div>
                <input type="hidden" id="editingIndex" value="">
                <button class="form-btn" id="saveApp">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';

            // --- Configuration ---
            const SECRET_CODE = "123456"; // Change this
            const SECRET_CALCULATION = "1+2+3="; // Sequence to trigger password
            const STORAGE_KEY = 'hiddenAppsData'; // Use a different key maybe
            const MAX_INPUT_LENGTH = 30; // Max length for display
            const MAX_EXPRESSION_LENGTH = 100; // Max length for expression

            // --- State ---
            const state = {
                currentInput: '0',
                expression: '',
                calculationSequence: '', // For secret trigger
                isInverse: false,
                isRadians: false, // Start in Degrees
                memory: 0,
                justCalculated: false, // Flag to overwrite input after '='
                openParentheses: 0,
                errorState: false,
            };

            // --- Elements ---
            const elements = {
                calculator: document.getElementById('calculator'),
                hiddenApps: document.getElementById('hiddenApps'),
                appForm: document.getElementById('appForm'),
                passwordScreen: document.getElementById('passwordScreen'),
                passwordInput: document.getElementById('passwordInput'),
                result: document.getElementById('result'),
                operation: document.getElementById('operation'),
                appList: document.getElementById('appList'),
                formTitle: document.getElementById('formTitle'),
                appTitle: document.getElementById('appTitle'),
                appLink: document.getElementById('appLink'),
                appIcon: document.getElementById('appIcon'),
                editingIndexInput: document.getElementById('editingIndex'),
                invBtn: document.getElementById('invBtn'),
                degRadBtn: document.getElementById('degRadBtn'),
                invIndicators: document.querySelectorAll('.btn sup'),
                buttons: document.querySelectorAll('.btn')
            };

            // --- Initialization ---
            function initialize() {
                // Ensure initial visibility states
                elements.hiddenApps.classList.remove('visible');
                elements.appForm.classList.remove('visible');
                elements.passwordScreen.classList.remove('visible');
                elements.calculator.classList.remove('hidden');

                // Load or initialize hidden apps data
                 if (!localStorage.getItem(STORAGE_KEY)) {
                     // Add more realistic default entries if needed
                    localStorage.setItem(STORAGE_KEY, JSON.stringify([
                         { title: "Ma Banque Principale", link: "Accès via application mobile", icon: "💰" },
                         { title: "Compte Crypto", link: "Utiliser l'app spécifique", icon: "🔒" },
                         { title: "Boîte Mail Perso", link: "mail.google.com", icon: "📧" },
                         { title: "Cloud Personnel", link: "drive.google.com", icon: "🗂️" },
                     ]));
                 }
                loadApps(); // Load and display apps
                updateDisplay();
                bindEvents();
                updateModeButtons(); // Set initial state of DEG/RAD/INV buttons
            }

            // --- Event Binding ---
            function bindEvents() {
                // Calculator buttons
                elements.buttons.forEach(button => {
                    button.addEventListener('click', () => handleInput(button.dataset.value));
                });

                // Hidden Apps Controls
                document.getElementById('closeApps').addEventListener('click', closeHiddenApps);
                document.getElementById('closeForm').addEventListener('click', closeAppForm);
                document.getElementById('saveApp').addEventListener('click', saveApp);

                // Password Screen
                document.getElementById('submitPassword').addEventListener('click', checkPassword);
                elements.passwordInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') checkPassword();
                    // Basic input filtering (allow only digits)
                    elements.passwordInput.value = elements.passwordInput.value.replace(/\D/g, '');
                });
                elements.passwordInput.addEventListener('input', () => {
                     elements.passwordInput.classList.remove('error'); // Remove error on input
                });
            }

             // --- Core Input Handler ---
            function handleInput(value) {
                if (state.errorState && value !== 'C') return; // Only allow Clear in error state

                // Track sequence for secret code *before* processing
                state.calculationSequence += value;
                if (state.calculationSequence.endsWith(SECRET_CALCULATION)) {
                    showPasswordScreen();
                    state.calculationSequence = ''; // Reset sequence
                    return; // Stop processing this input
                }
                if (state.calculationSequence.length > SECRET_CALCULATION.length + 5) {
                    state.calculationSequence = state.calculationSequence.slice(-10); // Keep it trimmed
                }

                // Handle different button types
                if (/\d/.test(value)) { // Digit
                    handleDigit(value);
                } else if (value === '.') { // Decimal
                    handleDecimal();
                } else if (['+', '-', '*', '/'].includes(value)) { // Basic Operators
                    handleOperator(value);
                } else if (value === '=') { // Equals
                    calculate();
                } else if (value === 'C') { // Clear
                    resetCalculator();
                } else if (value === 'DEL') { // Delete
                    handleDelete();
                } else if (value === '+/-') { // Sign Toggle
                    toggleSign();
                } else if (value === '%') { // Percent
                    applyPercent();
                } else if (value === '(' || value === ')') { // Parentheses
                    handleParenthesis(value);
                } else if (value === 'Inv') { // Inverse Toggle
                    toggleInverse();
                } else if (value === 'DEG' || value === 'RAD') { // Degree/Radian Toggle
                    toggleDegRad();
                } else if (['MC', 'MR', 'MS', 'M+', 'M-'].includes(value)) { // Memory Functions
                     handleMemory(value);
                 } else { // Scientific Functions & Constants
                    handleFunction(value);
                }

                // Update display after handling input (unless handled within function like calculate)
                if (value !== '=' && value !== 'Inv' && !(value === 'DEG' || value === 'RAD')) {
                     updateDisplay();
                }
            }

            // --- Input Handling Helpers ---

            function handleDigit(digit) {
                if (state.errorState) return;
                if (state.justCalculated || state.currentInput === '0') {
                    state.currentInput = digit;
                } else if (state.currentInput.length < MAX_INPUT_LENGTH) {
                    state.currentInput += digit;
                }
                state.justCalculated = false;
            }

            function handleDecimal() {
                 if (state.errorState) return;
                 if (state.justCalculated) {
                     state.currentInput = '0.';
                     state.justCalculated = false;
                 } else if (!state.currentInput.includes('.')) {
                    state.currentInput += '.';
                }
            }

            function handleOperator(op) {
                 if (state.errorState) return;
                 // Append current number and operator to expression
                if (state.currentInput !== '0' || state.expression.length > 0) {
                     // Avoid adding operator if expression ends with one, unless it's '-' for negative
                    const lastChar = state.expression.trim().slice(-1);
                    if (!['+', '*', '/', '^'].includes(lastChar) || (op === '-' && lastChar !== '-')) {
                        state.expression += ` ${state.currentInput} ${op} `;
                    } else if (['+', '*', '/', '^'].includes(lastChar) && op === '-') {
                        // Allow negative numbers after operator: "5 * -2"
                         state.expression += ` ${op}`; // Add space before negative sign potentially
                    } else {
                         // Replace last operator? Or just ignore? Let's replace.
                         state.expression = state.expression.trim().slice(0, -1) + ` ${op} `;
                    }
                } else if (op === '-') {
                    // Start with a negative number
                    state.currentInput = '-';
                    state.justCalculated = false;
                    updateDisplay(); // Update immediately to show the '-'
                    return; // Don't reset currentInput yet
                }

                state.currentInput = '0'; // Ready for next input
                state.justCalculated = false;
                if (state.expression.length > MAX_EXPRESSION_LENGTH) {
                    setError("Expression trop longue");
                }
                 updateDisplay(); // Show updated expression
            }

            function handleParenthesis(paren) {
                if (state.errorState) return;
                if (paren === '(') {
                    // Add '*' implicitly if needed: 5( -> 5*( ; (5+2)( -> (5+2)*(
                    const lastChar = state.expression.trim().slice(-1);
                    const lastInputChar = state.currentInput.slice(-1);
                     if (!isNaN(parseFloat(lastInputChar)) && state.currentInput !== '0') { // If currentInput is a number
                         state.expression += ` ${state.currentInput} * `;
                         state.currentInput = '0';
                     } else if (lastChar === ')' || !isNaN(parseFloat(lastChar))) {
                         state.expression += ' * ';
                     }

                    state.expression += ' ( ';
                    state.openParentheses++;
                } else if (paren === ')') {
                    if (state.openParentheses > 0) {
                        // Add current input before closing paren if it's not just '0' or empty
                        if (state.currentInput !== '0' && state.currentInput !== '-') {
                             state.expression += ` ${state.currentInput} `;
                        }
                        state.expression += ' ) ';
                        state.openParentheses--;
                        state.currentInput = '0'; // Reset input after closing paren
                    }
                }
                 state.justCalculated = false;
                 updateDisplay();
            }

             function handleDelete() {
                 if (state.errorState) return;
                 if (state.currentInput.length > 1) {
                     state.currentInput = state.currentInput.slice(0, -1);
                 } else {
                     state.currentInput = '0';
                 }
                 state.justCalculated = false;
                 updateDisplay();
             }

            function toggleSign() {
                if (state.errorState || state.currentInput === '0') return;
                if (state.currentInput.startsWith('-')) {
                    state.currentInput = state.currentInput.substring(1);
                } else {
                    state.currentInput = '-' + state.currentInput;
                }
                state.justCalculated = false;
                 updateDisplay();
            }

             function applyPercent() {
                 if (state.errorState) return;
                 try {
                     const currentValue = parseFloat(state.currentInput);
                     // Basic percentage: treat as N/100
                     // More complex would involve context (e.g., 100 + 10%)
                     state.currentInput = (currentValue / 100).toString();
                     state.justCalculated = false; // Allow further operations
                     updateDisplay();
                 } catch (e) {
                     setError("Erreur");
                 }
             }

             function toggleInverse() {
                 if (state.errorState) return;
                 state.isInverse = !state.isInverse;
                 elements.invBtn.classList.toggle('active', state.isInverse);
                 // Toggle visibility of sup text
                 elements.invIndicators.forEach(sup => {
                     sup.parentElement.classList.toggle('inv-active', state.isInverse);
                 });
             }

             function toggleDegRad() {
                 if (state.errorState) return;
                 state.isRadians = !state.isRadians;
                 updateModeButtons();
             }

             function updateModeButtons() {
                 if (state.isRadians) {
                     elements.degRadBtn.textContent = 'RAD';
                     elements.degRadBtn.dataset.value = 'RAD'; // Keep dataset value consistent
                 } else {
                     elements.degRadBtn.textContent = 'DEG';
                     elements.degRadBtn.dataset.value = 'DEG';
                 }
                 elements.degRadBtn.classList.toggle('active', state.isRadians);
             }

             function handleMemory(action) {
                 if (state.errorState) return;
                 const currentValue = parseFloat(state.currentInput);
                 if (isNaN(currentValue) && action !== 'MR' && action !== 'MC') return;

                 switch (action) {
                     case 'MS': // Memory Store
                         state.memory = currentValue;
                         state.justCalculated = true; // Storing usually means you're done with the number
                         break;
                     case 'MR': // Memory Recall
                         state.currentInput = state.memory.toString();
                         state.justCalculated = false; // Recalling means you might operate on it
                         break;
                     case 'MC': // Memory Clear
                         state.memory = 0;
                         break;
                     case 'M+': // Memory Add
                         state.memory += currentValue;
                         state.justCalculated = true;
                         break;
                     case 'M-': // Memory Subtract
                         state.memory -= currentValue;
                         state.justCalculated = true;
                         break;
                 }
                 // Optionally display 'M' indicator when memory is not 0
                 updateDisplay(); // Update display after memory op
             }


            // --- Calculation ---
            function calculate() {
                 if (state.errorState) return;
                // Append the final number
                 if (state.currentInput !== '0' || state.expression.trim() === '') {
                     // Avoid adding 0 if expression is empty and input is 0
                     if (state.currentInput !== '0' || state.expression.trim().length > 0) {
                         state.expression += ` ${state.currentInput}`;
                     }
                 }

                // Auto-close parentheses
                if (state.openParentheses > 0) {
                    state.expression += ' )'.repeat(state.openParentheses);
                    state.openParentheses = 0;
                }

                let expressionToEvaluate = state.expression.trim();
                 if (!expressionToEvaluate) {
                     // If only a number was entered, keep it
                     expressionToEvaluate = state.currentInput;
                 }

                 console.log("Raw expression:", expressionToEvaluate); // Debugging
                 if (expressionToEvaluate) {
                    try {
                        // Prepare expression for evaluation (replace symbols, handle functions)
                        expressionToEvaluate = prepareExpression(expressionToEvaluate);
                         console.log("Prepared expression:", expressionToEvaluate); // Debugging

                        // Use Function constructor for safer evaluation
                        const calculateFn = new Function('return ' + expressionToEvaluate);
                        let result = calculateFn();

                        if (!Number.isFinite(result)) {
                            throw new Error("Résultat invalide");
                        }

                        // Format result
                         state.currentInput = formatResult(result);
                        elements.operation.textContent = state.expression + ' ='; // Show full expression
                        state.expression = ''; // Reset expression
                        state.justCalculated = true;
                        state.errorState = false;

                    } catch (e) {
                         console.error("Calculation error:", e);
                         setError("Erreur"); // Set error state
                    }
                 } else {
                     // No expression, likely just pressed =
                     elements.operation.textContent = '';
                 }

                updateDisplay(); // Update result display
            }

            function prepareExpression(expr) {
                 // Replace user symbols with JS equivalents
                expr = expr.replace(/×/g, '*').replace(/÷/g, '/').replace(/−/g, '-');

                 // Handle Math functions (ensure correct arguments are passed)
                 // This requires more robust parsing than simple replace allows easily.
                 // For now, focus on constants and simple power/sqrt replacements.
                 expr = expr.replace(/π/g, 'Math.PI');
                 expr = expr.replace(/e(?!\w)/g, 'Math.E'); // Replace 'e' only if not part of a word (like 'exp')

                 // Basic power replacement (needs improvement for nested)
                 expr = expr.replace(/(\d+(\.\d+)?)\s*\^\s*(\d+(\.\d+)?)/g, 'Math.pow($1, $3)');
                 expr = expr.replace(/(\))*\s*\^\s*(\()*/g, 'Math.pow($1, $3)'); // Handle power with parens (simplified)


                 // Need a more robust parser for complex functions like log(x), sin(y), x^y etc.
                 // This simple replacement is limited.
                 return expr;
            }

            function handleFunction(func) {
                 if (state.errorState) return;
                 let value = parseFloat(state.currentInput);
                 if (isNaN(value)) return; // Don't operate on non-numbers

                let result;
                const requiresInverse = ['sin', 'cos', 'tan', 'log', 'ln', 'sqrt', 'x2', '^'];
                 const isFuncInverse = state.isInverse && requiresInverse.includes(func);

                try {
                    // Angle conversion for trig functions
                    let angle = value;
                    if (['sin', 'cos', 'tan', 'asin', 'acos', 'atan'].includes(func) || isFuncInverse) {
                         if (!state.isRadians) { // If in Degrees, convert TO Radians for Math functions
                             if(['sin', 'cos', 'tan'].includes(func)) angle = value * (Math.PI / 180);
                         }
                    }

                     switch (func) {
                        // Trig
                         case 'sin': result = isFuncInverse ? Math.asin(angle) : Math.sin(angle); break;
                         case 'cos': result = isFuncInverse ? Math.acos(angle) : Math.cos(angle); break;
                         case 'tan': result = isFuncInverse ? Math.atan(angle) : Math.tan(angle); break;
                        // Log / Exp
                         case 'log': result = isFuncInverse ? Math.pow(10, value) : Math.log10(value); break;
                         case 'ln': result = isFuncInverse ? Math.exp(value) : Math.log(value); break;
                         // Powers / Roots
                         case 'sqrt': result = isFuncInverse ? Math.pow(value, 3) : Math.sqrt(value); break; // Inv = x³
                         case 'x2': result = isFuncInverse ? Math.cbrt(value) : Math.pow(value, 2); break; // Inv = ³√x
                         case '^': // Becomes x^y - handle via operator? Or immediate? Let's make it an operator.
                             handleOperator('^'); return; // Don't calculate immediately
                         // Constants (replace input)
                         case 'pi': result = Math.PI; break;
                         case 'e': result = Math.E; break;
                         // Factorial
                         case '!': result = factorial(value); break;
                         default: return; // Unknown function
                     }

                    // Convert trig results back to degrees if needed
                    if (['asin', 'acos', 'atan'].includes(func) || (isFuncInverse && ['sin', 'cos', 'tan'].includes(func))) {
                         if (!state.isRadians) { // If in Degrees, convert result FROM Radians
                             result = result * (180 / Math.PI);
                         }
                    }


                    if (!Number.isFinite(result)) throw new Error("Résultat invalide");

                     state.currentInput = formatResult(result);
                     state.justCalculated = true; // Function applied, treat as calculation result
                     // Reset inverse state after use? Optional, depends on desired behavior.
                     // if (state.isInverse) toggleInverse();
                 } catch (e) {
                     setError("Erreur");
                     console.error("Function error:", e);
                 }
                 updateDisplay();
             }


             function factorial(n) {
                 if (n < 0 || !Number.isInteger(n)) return NaN; // Factorial defined for non-negative integers
                 if (n === 0 || n === 1) return 1;
                 let result = 1;
                 for (let i = n; i > 1; i--) {
                     result *= i;
                     if (result === Infinity) return Infinity; // Avoid overly long loops
                 }
                 return result;
             }


            function formatResult(value) {
                 // Avoid scientific notation for reasonably sized numbers
                 // Limit decimal places
                 if (Math.abs(value) > 1e12 || (Math.abs(value) < 1e-6 && value !== 0)) {
                     return value.toExponential(6);
                 } else {
                     // Round to a reasonable number of decimals
                     return parseFloat(value.toFixed(10)).toString();
                 }
            }


            // --- Display Update ---
            function updateDisplay() {
                elements.result.textContent = state.currentInput;
                 // Show memory indicator (optional)
                 // elements.memoryIndicator.style.visibility = state.memory !== 0 ? 'visible' : 'hidden';

                 // Only update expression display if it's not in error state
                 if (!state.errorState) {
                     elements.operation.textContent = state.expression;
                 }

                 // Adjust font size if too long (simple approach)
                 if (state.currentInput.length > 15) {
                     elements.result.style.fontSize = '1.5em';
                 } else if (state.currentInput.length > 10) {
                    elements.result.style.fontSize = '1.8em';
                 } else {
                     elements.result.style.fontSize = '2.2em';
                 }
            }

            // --- Error Handling ---
            function setError(message) {
                state.currentInput = message;
                state.expression = '';
                state.errorState = true;
                elements.operation.textContent = ''; // Clear expression display on error
                updateDisplay(); // Show the error message
            }


            // --- Reset ---
            function resetCalculator() {
                state.currentInput = '0';
                state.expression = '';
                state.calculationSequence = '';
                // Don't reset Inverse or Deg/Rad mode on 'C' ? User preference. Let's keep them.
                // state.isInverse = false;
                // state.isRadians = false;
                state.justCalculated = false;
                state.openParentheses = 0;
                 state.errorState = false; // Clear error state
                // updateModeButtons();
                // if (state.isInverse) toggleInverse(); // Ensure Inv indicator resets if toggled off
                 updateDisplay();
            }


            // --- Hidden Apps Logic (Mostly Unchanged) ---

            function showPasswordScreen() {
                resetCalculator(); // Clear calc before showing password
                elements.passwordScreen.classList.add('visible');
                elements.passwordInput.value = ''; // Clear previous attempts
                elements.passwordInput.focus();
            }

            function checkPassword() {
                if (elements.passwordInput.value === SECRET_CODE) {
                    elements.passwordScreen.classList.remove('visible');
                    elements.calculator.classList.add('hidden'); // Hide calculator
                    elements.hiddenApps.classList.add('visible'); // Show apps
                    elements.passwordInput.value = '';
                    elements.passwordInput.classList.remove('error');
                    loadApps(); // Refresh app list when shown
                } else {
                    elements.passwordInput.classList.add('error');
                    elements.passwordInput.value = '';
                    // Optional: Provide feedback (shake animation is good)
                    setTimeout(() => {
                         if (elements.passwordInput) { // Check if element still exists
                             elements.passwordInput.classList.remove('error');
                         }
                    }, 500);
                }
            }

            function closeHiddenApps() {
                elements.hiddenApps.classList.remove('visible');
                elements.calculator.classList.remove('hidden'); // Show calculator
                resetCalculator(); // Reset calculator state when closing
            }

            function loadApps() {
                 const apps = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                 const fragment = document.createDocumentFragment();

                 // Create and prepend the "Add App" button structure
                 const addAppDiv = document.createElement('div');
                 addAppDiv.className = 'add-app';
                 addAppDiv.id = 'addAppBtn'; // Keep ID if needed for event listener
                 addAppDiv.innerHTML = `
                     <div>
                         <div class="app-title">Ajouter un accès</div>
                         <div class="app-desc">Créer un nouvel accès sécurisé</div>
                     </div>
                     <div class="add-icon">+</div>
                 `;
                 addAppDiv.addEventListener('click', openAddForm);
                 fragment.appendChild(addAppDiv);


                 apps.forEach((app, index) => {
                     const appItem = document.createElement('div');
                     appItem.className = 'app-item';
                     appItem.innerHTML = `
                         <div class="app-icon">${sanitize(app.icon || '❓')}</div>
                         <div class="app-info">
                             <div class="app-title">${sanitize(app.title)}</div>
                             <div class="app-desc">${sanitize(app.link)}</div>
                         </div>
                         <div class="app-actions">
                             <button class="action-btn edit" data-index="${index}" title="Modifier">✏️</button>
                             <button class="action-btn delete" data-index="${index}" title="Supprimer">🗑️</button>
                         </div>
                     `;

                     // Add event listeners directly here
                     appItem.querySelector('.app-info').addEventListener('click', () => openLink(app.link, app.title));
                     appItem.querySelector('.edit').addEventListener('click', (e) => {
                          e.stopPropagation(); // Prevent triggering openLink
                          editApp(index);
                     });
                    appItem.querySelector('.delete').addEventListener('click', (e) => {
                         e.stopPropagation(); // Prevent triggering openLink
                         deleteApp(index);
                     });

                    fragment.appendChild(appItem);
                 });

                 elements.appList.innerHTML = ''; // Clear previous list
                 elements.appList.appendChild(fragment);
             }

            function sanitize(str) {
                 const temp = document.createElement('div');
                 temp.textContent = str;
                 return temp.innerHTML;
             }


             function openLink(link, title) {
                 if (/^https?:\/\//i.test(link) || /^mailto:/i.test(link) || /^tel:/i.test(link)) {
                     // Use window.open for web links, let the browser handle mailto/tel
                     window.open(link, '_blank', 'noopener,noreferrer');
                 } else if (/^\w+:\/\//i.test(link)) {
                     // Attempt to open other protocols (might be blocked by browser)
                      window.open(link, '_blank', 'noopener,noreferrer');
                 }
                  else {
                     // If it doesn't look like a URL, show an alert
                     alert(`Accès: ${title}\nInfo: ${link}`);
                 }
             }

            function openAddForm() {
                 state.editingIndex = null; // Use state object
                 elements.editingIndexInput.value = ''; // Clear hidden input too
                 elements.formTitle.textContent = "Ajouter un accès";
                 elements.appTitle.value = '';
                 elements.appLink.value = '';
                 elements.appIcon.value = '💰'; // Default icon
                 elements.appForm.classList.add('visible');
             }

            function closeAppForm() {
                 elements.appForm.classList.remove('visible');
             }

            function saveApp() {
                 const title = elements.appTitle.value.trim();
                 const link = elements.appLink.value.trim();
                 const icon = elements.appIcon.value;
                 const indexToEdit = elements.editingIndexInput.value;

                 if (!title || !link) {
                     alert("Le nom et le lien/description sont obligatoires.");
                     return;
                 }

                 const apps = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                 const newApp = { title, link, icon };

                 if (indexToEdit !== '') { // Editing existing
                     const idx = parseInt(indexToEdit, 10);
                     if (idx >= 0 && idx < apps.length) {
                         apps[idx] = newApp;
                     }
                 } else { // Adding new
                     apps.push(newApp);
                 }

                 localStorage.setItem(STORAGE_KEY, JSON.stringify(apps));
                 closeAppForm();
                 loadApps(); // Refresh list
             }

            function editApp(index) {
                 const apps = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                 if (index >= 0 && index < apps.length) {
                     const app = apps[index];
                     elements.editingIndexInput.value = index.toString(); // Store index
                     elements.formTitle.textContent = "Modifier l'accès";
                     elements.appTitle.value = app.title;
                     elements.appLink.value = app.link;
                     elements.appIcon.value = app.icon || '💰'; // Handle missing icon
                     elements.appForm.classList.add('visible');
                 }
             }

            function deleteApp(index) {
                 if (!confirm("Voulez-vous vraiment supprimer cet accès ? Cette action est irréversible.")) {
                      return;
                  }
                 const apps = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                 if (index >= 0 && index < apps.length) {
                     apps.splice(index, 1);
                     localStorage.setItem(STORAGE_KEY, JSON.stringify(apps));
                     loadApps(); // Refresh list
                 }
             }

            // --- Start the App ---
            document.addEventListener('DOMContentLoaded', initialize);

        })();
    </script>
</body>
</html>
